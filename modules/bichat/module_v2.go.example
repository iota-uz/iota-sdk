package bichat

import (
	"embed"

	"github.com/iota-uz/iota-sdk/modules/bichat/permissions"
	"github.com/iota-uz/iota-sdk/pkg/application"
	"github.com/iota-uz/iota-sdk/pkg/rbac"
	"github.com/iota-uz/iota-sdk/pkg/spotlight"
)

//go:embed presentation/locales/*.json
var LocaleFiles embed.FS

//go:embed infrastructure/persistence/schema/bichat-schema.sql
var MigrationFiles embed.FS

// TODO: Uncomment when Phase 1 (Agent Framework) is complete
// //go:embed infrastructure/persistence/schema/bichat-schema-v2.sql
// var MigrationFilesV2 embed.FS

// ModuleV2 represents the BI-Chat module with Phase 7 configuration.
// This is the production-ready module implementation following the plan.
//
// Status:
//   ✅ Configuration (config.go)
//   ✅ Interop layer (presentation/interop/)
//   ✅ Permissions (permissions/)
//   ✅ Translations (presentation/locales/)
//   ✅ GraphQL schema (presentation/graphql/schema.graphql)
//   ⏳ PostgreSQL repository (pending Phase 1)
//   ⏳ Chat service (pending Phase 1)
//   ⏳ Agent service (pending Phase 1)
//   ⏳ Controllers (pending Phase 1)
//   ⏳ Database migrations (pending Phase 1)
//
// TODO: Replace the existing Module with ModuleV2 when Phase 1 is complete.
type ModuleV2 struct {
	config *ModuleConfig
}

// NewModuleV2 creates a new BI-Chat module with the given configuration.
// TODO: Replace NewModule() with this when Phase 1 is complete.
//
// Example usage:
//
//	cfg := bichat.NewModuleConfig(
//	    composables.UseTenantID,
//	    composables.UseUserID,
//	    chatRepo,
//	    llmModel,
//	    bichat.DefaultContextPolicy(),
//	    parentAgent,
//	    bichat.WithQueryExecutor(queryExecutor),
//	    bichat.WithKBSearcher(kbSearcher),
//	)
//	module := bichat.NewModuleV2(cfg)
//	app.RegisterModule(module)
func NewModuleV2(config *ModuleConfig) (application.Module, error) {
	// Validate configuration
	if err := config.Validate(); err != nil {
		return nil, err
	}

	return &ModuleV2{
		config: config,
	}, nil
}

// Register registers the module with the application.
// TODO: Complete implementation when Phase 1 is finished.
func (m *ModuleV2) Register(app application.Application) error {
	// Register migrations
	app.Migrations().RegisterSchema(&MigrationFiles)
	// TODO: Uncomment when Phase 1 is complete
	// app.Migrations().RegisterSchema(&MigrationFilesV2)

	// Register locale files
	app.RegisterLocaleFiles(&LocaleFiles)

	// Register permissions
	if err := m.registerPermissions(app); err != nil {
		return err
	}

	// TODO: Uncomment when Phase 1 is complete
	// Register repositories
	// chatRepo := persistence.NewPostgresChatRepository()
	// app.RegisterServices(chatRepo)

	// TODO: Uncomment when Phase 1 is complete
	// Register services
	// chatService := services.NewChatService(
	//     m.config.ChatRepo,
	//     m.config.TenantID,
	//     m.config.UserID,
	//     m.config.EventBus,
	// )
	// agentService := services.NewAgentService(
	//     m.config.ParentAgent,
	//     m.config.SubAgents,
	//     m.config.Model,
	//     m.config.EventBus,
	// )
	// app.RegisterServices(chatService, agentService)

	// TODO: Uncomment when Phase 1 is complete
	// Register controllers
	// app.RegisterControllers(
	//     controllers.NewChatController(app, chatService, agentService),
	//     controllers.NewStreamController(app, chatService),
	//     controllers.NewWebController(app),
	// )

	// TODO: Uncomment when Phase 1 is complete
	// Register GraphQL schema
	// app.RegisterGraphSchema(application.GraphSchema{
	//     Value:    graph.NewExecutableSchema(graph.Config{
	//         Resolvers: graph.NewResolver(app, chatService),
	//     }),
	//     BasePath: "/bichat",
	// })

	// Register event handlers
	if err := m.registerEventHandlers(app); err != nil {
		return err
	}

	// Register quick links
	app.QuickLinks().Add(
		spotlight.NewQuickLink(BiChatLink.Icon, BiChatLink.Name, BiChatLink.Href),
	)

	return nil
}

// Name returns the module name.
func (m *ModuleV2) Name() string {
	return "bichat"
}

// registerPermissions registers BiChat permissions with the application.
func (m *ModuleV2) registerPermissions(app application.Application) error {
	// Get permission schema from app
	schema := app.GetPermissionSchema()
	if schema == nil {
		// No permission schema available (testing mode or permission system disabled)
		return nil
	}

	// Register permissions
	for _, perm := range permissions.Permissions {
		if err := schema.Add(perm); err != nil {
			// Permission already registered is not an error
			if err != rbac.ErrPermissionExists {
				return err
			}
		}
	}

	return nil
}

// registerEventHandlers registers event handlers for observability.
func (m *ModuleV2) registerEventHandlers(app application.Application) error {
	if m.config.EventBus == nil {
		return nil
	}

	// TODO: Uncomment when Phase 1 is complete
	// Register logging handler
	// if m.config.Logger != nil {
	//     loggingHandler := hooks.NewLoggingHandler(m.config.Logger, logrus.InfoLevel)
	//     m.config.EventBus.SubscribeAll(loggingHandler)
	// }

	// TODO: Uncomment when Phase 1 is complete
	// Register metrics handler (if Prometheus registry available)
	// if registry := app.GetMetricsRegistry(); registry != nil {
	//     metricsHandler := hooks.NewMetricsHandler(registry)
	//     m.config.EventBus.SubscribeAll(metricsHandler)
	// }

	return nil
}

// Config returns the module configuration.
// Useful for accessing dependencies after module registration.
func (m *ModuleV2) Config() *ModuleConfig {
	return m.config
}
