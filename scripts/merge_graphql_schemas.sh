#!/bin/bash

# Exit immediately if a command exits with a non-zero status.
set -e

# --- Configuration ---
# Directory where your modules reside
MODULES_DIR="../modules"
# Target directory for the merged schema (relative to project root)
TARGET_DIR="."
# Name of the merged output file
OUTPUT_FILE="schema.merged.graphql"
# --- End Configuration ---

TARGET_PATH="$TARGET_DIR/$OUTPUT_FILE"

# Ensure the target directory exists
mkdir -p "$TARGET_DIR"

echo "# Auto-generated by scripts/merge_schemas.sh - DO NOT EDIT MANUALLY" > "$TARGET_PATH"
echo "# $(date)" >> "$TARGET_PATH"
echo "" >> "$TARGET_PATH"

# Find all .graphqls files under the modules directory, sort them,
# and append their content to the target file.
# Sorting helps maintain a consistent order.
find "$MODULES_DIR" -type f -name '*.graphql' | sort | while read -r file;
do
    echo "# --- Merging $file ---" >> "$TARGET_PATH"
    cat "$file" >> "$TARGET_PATH"
    echo "" >> "$TARGET_PATH" # Add a newline between files
    echo "# --- End $file ---" >> "$TARGET_PATH"
    echo "" >> "$TARGET_PATH"
done

# Check if any files were found and merged
# The line count check isn't perfect but gives some indication.
# We added at least 3 header lines + blank lines.
if [ $(wc -l < "$TARGET_PATH") -le 5 ]; then
  echo "Warning: No schema files found or files were empty in $MODULES_DIR"
  # Optional: Add a minimal valid schema if none found, to prevent gqlgen errors
  # echo "type Query { _empty: Boolean }" >> "$TARGET_PATH"
fi

echo "Successfully merged schemas to $TARGET_PATH"