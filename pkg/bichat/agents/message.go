package agents

import (
	"time"

	"github.com/google/uuid"
)

// Role represents the message sender in a conversation.
type Role string

const (
	// RoleSystem represents system-level instructions.
	RoleSystem Role = "system"
	// RoleUser represents messages from the user.
	RoleUser Role = "user"
	// RoleAssistant represents messages from the AI assistant.
	RoleAssistant Role = "assistant"
	// RoleTool represents tool execution results.
	RoleTool Role = "tool"
)

// Citation represents a source citation from web search or other sources.
type Citation struct {
	Type       string `json:"type"`        // "url_citation"
	Title      string `json:"title"`       // Page title
	URL        string `json:"url"`         // Source URL
	StartIndex int    `json:"start_index"` // Start position in content
	EndIndex   int    `json:"end_index"`   // End position in content
}

// CodeInterpreterResult represents the result of a code interpreter execution.
type CodeInterpreterResult struct {
	ID          string `json:"id"`           // Unique ID for this execution
	Code        string `json:"code"`         // Python code that was executed
	ContainerID string `json:"container_id"` // Container ID where code ran
	Status      string `json:"status"`       // "completed", "failed"
	Logs        string `json:"logs"`         // stdout/stderr output
}

// FileAnnotation represents a file generated by code interpreter.
type FileAnnotation struct {
	Type        string `json:"type"`         // "container_file_citation"
	ContainerID string `json:"container_id"` // Container ID
	FileID      string `json:"file_id"`      // File ID in provider storage
	Filename    string `json:"filename"`     // Original filename
	StartIndex  int    `json:"start_index"`  // Start position in content
	EndIndex    int    `json:"end_index"`    // End position in content
}

// Message represents a conversation message in the agent context.
type Message struct {
	ID         uuid.UUID
	Role       Role
	Content    string
	ToolCallID *string    // For tool response messages
	ToolCalls  []ToolCall // For assistant messages with tool calls
	Citations  []Citation // For assistant messages with citations (e.g., web search)
	CreatedAt  time.Time
}

// ToolCall represents a tool invocation request from the assistant.
type ToolCall struct {
	ID        string
	Name      string
	Arguments string // JSON string
}

// ToolCallResult holds the result of a tool execution.
type ToolCallResult struct {
	ToolCall
	Result     string
	Error      error
	DurationMs int64
}

// Attachment represents a file attachment in a message.
type Attachment struct {
	ID          uuid.UUID
	Filename    string
	ContentType string
	Data        []byte
	URL         *string
}

// TokenUsage tracks token consumption for cost monitoring.
type TokenUsage struct {
	PromptTokens     int
	CompletionTokens int
	TotalTokens      int
}

// NewUserMessage creates a user message with the given content.
func NewUserMessage(content string) Message {
	return Message{
		ID:        uuid.New(),
		Role:      RoleUser,
		Content:   content,
		CreatedAt: time.Now(),
	}
}

// NewAssistantMessage creates an assistant message with optional tool calls.
func NewAssistantMessage(content string, toolCalls []ToolCall) Message {
	return Message{
		ID:        uuid.New(),
		Role:      RoleAssistant,
		Content:   content,
		ToolCalls: toolCalls,
		CreatedAt: time.Now(),
	}
}

// NewToolMessage creates a tool response message for a specific tool call.
func NewToolMessage(toolCallID, content string) Message {
	return Message{
		ID:         uuid.New(),
		Role:       RoleTool,
		Content:    content,
		ToolCallID: &toolCallID,
		CreatedAt:  time.Now(),
	}
}

// NewSystemMessage creates a system message with instructions.
func NewSystemMessage(content string) Message {
	return Message{
		ID:        uuid.New(),
		Role:      RoleSystem,
		Content:   content,
		CreatedAt: time.Now(),
	}
}
