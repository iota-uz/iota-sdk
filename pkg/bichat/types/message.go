package types

import (
	"time"

	"github.com/google/uuid"
)

// Message represents a message in a conversation.
type Message struct {
	// ID is the unique identifier for this message
	ID uuid.UUID

	// SessionID is the ID of the session this message belongs to
	SessionID uuid.UUID

	// Role is the role of the message sender
	Role Role

	// Content is the text content of the message
	Content string

	// ToolCalls contains tool invocation requests (for assistant messages)
	ToolCalls []ToolCall

	// ToolCallID is the ID of the tool call this message responds to (for tool messages)
	ToolCallID *string

	// Attachments contains files attached to this message
	Attachments []Attachment

	// Citations contains source citations for this message
	Citations []Citation

	// CodeOutputs contains files generated by code interpreter
	// Only populated for assistant messages that used code_interpreter tool
	CodeOutputs []CodeInterpreterOutput

	// CreatedAt is when the message was created
	CreatedAt time.Time
}

// MessageOption is a functional option for configuring a Message.
type MessageOption func(*Message)

// WithMessageID sets the message ID.
func WithMessageID(id uuid.UUID) MessageOption {
	return func(m *Message) {
		m.ID = id
	}
}

// WithSessionID sets the session ID.
func WithSessionID(id uuid.UUID) MessageOption {
	return func(m *Message) {
		m.SessionID = id
	}
}

// WithToolCalls sets the tool calls.
func WithToolCalls(calls ...ToolCall) MessageOption {
	return func(m *Message) {
		m.ToolCalls = calls
	}
}

// WithAttachments sets the attachments.
func WithAttachments(attachments ...Attachment) MessageOption {
	return func(m *Message) {
		m.Attachments = attachments
	}
}

// WithCitations sets the citations.
func WithCitations(citations ...Citation) MessageOption {
	return func(m *Message) {
		m.Citations = citations
	}
}

// WithCodeOutputs sets the code interpreter outputs.
func WithCodeOutputs(outputs ...CodeInterpreterOutput) MessageOption {
	return func(m *Message) {
		m.CodeOutputs = outputs
	}
}

// WithCreatedAt sets the created timestamp.
func WithCreatedAt(t time.Time) MessageOption {
	return func(m *Message) {
		m.CreatedAt = t
	}
}

// UserMessage creates a new user message with the given content.
func UserMessage(content string, opts ...MessageOption) *Message {
	m := &Message{
		ID:        uuid.New(),
		Role:      RoleUser,
		Content:   content,
		CreatedAt: time.Now(),
	}
	for _, opt := range opts {
		opt(m)
	}
	return m
}

// AssistantMessage creates a new assistant message with the given content.
func AssistantMessage(content string, opts ...MessageOption) *Message {
	m := &Message{
		ID:        uuid.New(),
		Role:      RoleAssistant,
		Content:   content,
		CreatedAt: time.Now(),
	}
	for _, opt := range opts {
		opt(m)
	}
	return m
}

// ToolResponse creates a new tool message with the given tool call ID and result.
func ToolResponse(toolCallID, result string) *Message {
	return &Message{
		ID:         uuid.New(),
		Role:       RoleTool,
		Content:    result,
		ToolCallID: &toolCallID,
		CreatedAt:  time.Now(),
	}
}

// SystemMessage creates a new system message with the given content.
func SystemMessage(content string) *Message {
	return &Message{
		ID:        uuid.New(),
		Role:      RoleSystem,
		Content:   content,
		CreatedAt: time.Now(),
	}
}

// HasToolCalls returns true if the message has tool calls.
func (m *Message) HasToolCalls() bool {
	return len(m.ToolCalls) > 0
}

// HasAttachments returns true if the message has attachments.
func (m *Message) HasAttachments() bool {
	return len(m.Attachments) > 0
}

// HasCitations returns true if the message has citations.
func (m *Message) HasCitations() bool {
	return len(m.Citations) > 0
}

// IsToolMessage returns true if the message is a tool response message.
func (m *Message) IsToolMessage() bool {
	return m.ToolCallID != nil
}

// HasCodeOutputs returns true if the message has code interpreter outputs.
func (m *Message) HasCodeOutputs() bool {
	return len(m.CodeOutputs) > 0
}
