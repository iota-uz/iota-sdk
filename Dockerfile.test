FROM golang:1.23.2

WORKDIR /build

ARG JUST_VERSION=1.46.0
ARG GOLANGCI_LINT_VERSION=v2.1.6
RUN set -eux; \
    arch="$(uname -m)"; \
    case "$arch" in \
      x86_64|amd64) target="x86_64-unknown-linux-musl" ;; \
      aarch64|arm64) target="aarch64-unknown-linux-musl" ;; \
      *) echo "Unsupported arch for just: $arch" ; exit 1 ;; \
    esac; \
    curl -sSfL "https://github.com/casey/just/releases/download/${JUST_VERSION}/just-${JUST_VERSION}-${target}.tar.gz" \
      | tar -xz -C /usr/local/bin just; \
    chmod +x /usr/local/bin/just; \
    just --version

COPY scripts/install.sh .
RUN chmod +x install.sh && ./install.sh && go install github.com/a-h/templ/cmd/templ@v0.3.856

RUN set -eux; \
    curl -sSfL "https://raw.githubusercontent.com/golangci/golangci-lint/${GOLANGCI_LINT_VERSION}/install.sh" -o /tmp/golangci-lint-install.sh && \
    sh /tmp/golangci-lint-install.sh -b "$(go env GOPATH)/bin" "${GOLANGCI_LINT_VERSION}" && \
    rm -f /tmp/golangci-lint-install.sh

COPY go.mod go.sum ./
RUN go mod download
COPY . .

CMD ["sh", "-c", "go vet -tags dev ./... && golangci-lint run --build-tags dev ./... && go test -tags dev -v ./..."]
