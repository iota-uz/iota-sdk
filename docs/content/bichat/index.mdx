---
title: 'BiChat Module'
description: 'Agent-powered business intelligence chat for data insights'
---

# BiChat Module

The BiChat (Business Intelligence Chat) module provides an agent-powered conversational interface for querying business data and gaining insights. Built on the `pkg/bichat` foundation, it uses a multi-agent orchestration system to handle complex data analysis tasks.

## Purpose

This module enables:
- **Natural Language Data Queries**: Ask questions about your business data in plain English.
- **Multi-Agent Analysis**: A parent BI agent coordinates with specialized sub-agents (like the SQL Analyst) to solve complex tasks.
- **Real-time Data Exploration**: Live execution of SQL queries against your business database.
- **HITL (Human-in-the-Loop)**: Agents can pause execution to ask the user for clarification or missing information.
- **Data Export**: Export query results directly to Excel.

## Key Concepts

### Agents

The system uses an orchestration pattern:
- **BI Agent (Parent)**: The primary interface that understands user intent and coordinates the workflow.
- **SQL Analyst (Sub-agent)**: Specialized in understanding database schema and generating precise SQL queries.
- **Delegation Tool**: Allows agents to hand off tasks to specialized sub-agents when needed.

### Sessions & Messages

- **Session**: A continuous conversation context tied to a user and tenant.
- **Message**: Individual exchanges between the user and agents, supporting text and file attachments.
- **Context Management**: Content-addressed context building that intelligently summarizes history to fit LLM token windows.

### HITL (Human-in-the-Loop)

When an agent needs more information (e.g., "Which warehouse should I check?"), it uses the `ask_user_question` tool. This triggers an interrupt, saves the agent's state as a **Checkpoint**, and waits for a user answer before resuming.

## Architecture

```mermaid
graph TB
    subgraph "BiChat Module Architecture"
        A[React SPA] --> B[GraphQL/SSE Controllers]
        B --> C[AgentService]
        
        subgraph "Agent Framework (pkg/bichat)"
            C --> D[Executor]
            D --> E[Parent BI Agent]
            E --> F[Sub-Agents (SQL Analyst)]
        end
        
        subgraph "Tools"
            E --> G[Knowledge Base Search]
            F --> H[SQL Execute]
            E --> I[Chart Generation]
            E --> J[Excel Export]
        end
    end
    
    C --> K[(PostgreSQL Storage)]
    E --> L[LLM Provider (OpenAI)]
```

## API Reference

### REST/SSE Endpoints

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/bi-chat` | GET | Serves the React SPA |
| `/bi-chat/stream` | POST | SSE streaming endpoint for agent responses |
| `/bi-chat/graphql` | POST | GraphQL API for session management |

### GraphQL Operations

**Queries:**
- `sessions`: List user's chat sessions
- `session(id)`: Get detailed session state
- `messages(sessionId)`: Get conversation history

**Mutations:**
- `createSession(title)`: Start a new conversation
- `sendMessage(sessionId, content, attachments)`: Send a message to the agent
- `resumeWithAnswer(sessionId, checkpointId, answers)`: Resume after an interrupt
- `archiveSession(id)`: Archive a session
- `deleteSession(id)`: Permanently remove a session

## Permissions

| Permission | Resource | Description |
|------------|----------|-------------|
| `BiChat.Access` | `bichat` | Access the BI Chat interface and their own sessions |
| `BiChat.ReadAll` | `bichat` | View chat sessions from all users in the tenant |
| `BiChat.Export` | `bichat` | Use data export tools within the chat |

## Data Sources

The **SQL Analyst** agent has read-only access to the `analytics` schema in the database. Developers should create tenant-isolated views in this schema to expose data to BiChat:

```sql
CREATE VIEW analytics.tenant_sales AS
SELECT * FROM sales 
WHERE tenant_id = current_setting('app.tenant_id', true)::UUID;
```

## Configuration

The module is configured via `ModuleConfig` in Go:

```go
cfg := bichat.NewModuleConfig(
    chatRepo,
    llmModel,
    bichat.DefaultContextPolicy(),
    parentAgent,
    bichat.WithQueryExecutor(executor),
    bichat.WithVision(true),
    bichat.WithMultiAgent(true),
)
```

## Environment Variables

| Variable | Required | Description |
|----------|----------|-------------|
| `OPENAI_API_KEY` | Yes | API key for OpenAI |
| `OPENAI_MODEL` | No | Default model (defaults to `gpt-4o`) |
| `BICHAT_CONTEXT_WINDOW` | No | Max tokens for context (default: 200k) |