name: Claude Code

on:
  issue_comment:
    types: [created, edited]
  pull_request_review_comment:
    types: [created, edited]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  workflow_dispatch:

jobs:
  claude:
    if: |
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'issue_comment' && (
        contains(github.event.comment.body, '@claude') ||
        contains(github.event.comment.body, '@opus') ||
        contains(github.event.comment.body, '@sonnet') ||
        contains(github.event.comment.body, '@haiku')
      )) ||
      (github.event_name == 'pull_request_review_comment' && (
        contains(github.event.comment.body, '@claude') ||
        contains(github.event.comment.body, '@opus') ||
        contains(github.event.comment.body, '@sonnet') ||
        contains(github.event.comment.body, '@haiku')
      )) ||
      (github.event_name == 'pull_request_review' && (
        contains(github.event.review.body, '@claude') ||
        contains(github.event.review.body, '@opus') ||
        contains(github.event.review.body, '@sonnet') ||
        contains(github.event.review.body, '@haiku')
      )) ||
      (github.event_name == 'issues' && (
        contains(github.event.issue.body, '@claude') ||
        contains(github.event.issue.body, '@opus') ||
        contains(github.event.issue.body, '@sonnet') ||
        contains(github.event.issue.body, '@haiku')
      ))
    runs-on: blacksmith-16vcpu-ubuntu-2404
    timeout-minutes: 90
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
      models: read

    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: iota_sdk_claude
          POSTGRES_INITDB_ARGS: >-
            -c max_connections=1000
            -c shared_buffers=2GB
            -c fsync=off
            -c synchronous_commit=off
            -c full_page_writes=off
            -c autovacuum=off
            -c jit=off
        ports:
          - 5432:5432
        options: >-
          --hostname=iota_db_claude
          --tmpfs /var/lib/postgresql/data:rw,size=4g,noatime
          --health-cmd="pg_isready -U postgres -d iota_sdk_claude"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: staging
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install Railway CLI
        run: npm install -g @railway/cli@4.12.0

      - name: Authenticate Railway CLI
        env:
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_SERVICE_TOKEN }}
        run: |
          if [ -n "$RAILWAY_API_TOKEN" ]; then
            if railway whoami 2>/dev/null; then
              echo "Railway authentication successful"
            else
              echo "Warning: Railway authentication failed"
            fi
          else
            echo "Railway token not configured, skipping authentication"
          fi

      - name: Detect model
        id: detect_model
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          EVENT_NAME: ${{ github.event_name }}
          COMMENT_BODY: ${{ github.event.comment.body || '' }}
          REVIEW_BODY: ${{ github.event.review.body || '' }}
          ISSUE_TITLE: ${{ github.event.issue.title || '' }}
          ISSUE_BODY: ${{ github.event.issue.body || '' }}
          ISSUE_NUMBER: ${{ github.event.issue.number || '' }}
          IS_PR: ${{ github.event.issue.pull_request && 'true' || '' }}
          PR_NUMBER: ${{ github.event.pull_request.number || '' }}
        run: |
          # Determine trigger body based on event type
          case "$EVENT_NAME" in
            issue_comment|pull_request_review_comment) TRIGGER_BODY="$COMMENT_BODY";;
            pull_request_review) TRIGGER_BODY="$REVIEW_BODY";;
            issues) TRIGGER_BODY="$ISSUE_BODY";;
            *) TRIGGER_BODY="";;
          esac

          # Build context based on event type
          DELIM="__EOF_$(date +%s)__"

          if [ "$EVENT_NAME" = "issues" ] && [ -z "$IS_PR" ]; then
            # Pure issue: title + body
            TRIGGER_CONTEXT="## Issue: $ISSUE_TITLE

          $ISSUE_BODY"
          elif [ -n "$PR_NUMBER" ] || [ -n "$IS_PR" ]; then
            # PR context: use PR_NUMBER if available, otherwise ISSUE_NUMBER (for issue_comment on PR)
            PR_NUM="${PR_NUMBER:-$ISSUE_NUMBER}"
            if [ -n "$PR_NUM" ]; then
              PR_INFO=$(gh pr view "$PR_NUM" --json title,body,files --jq '{title, body, files: [.files[].path]}' 2>/dev/null || echo '{}')
              PR_TITLE=$(echo "$PR_INFO" | jq -r '.title // "Unknown"')
              PR_BODY=$(echo "$PR_INFO" | jq -r '.body // ""')
              PR_FILES=$(echo "$PR_INFO" | jq -r '.files // [] | join(", ")')
              DIFF_STAT=$(gh pr diff "$PR_NUM" --stat 2>/dev/null | tail -1 || echo "")

              TRIGGER_CONTEXT="## PR: $PR_TITLE

          ### Summary
          $PR_BODY

          ### Files Changed
          $PR_FILES

          ### Diff Stats
          $DIFF_STAT"
            else
              TRIGGER_CONTEXT=""
            fi
          else
            TRIGGER_CONTEXT=""
          fi

          # Export and run detection script
          export TRIGGER_BODY TRIGGER_CONTEXT
          RESULT=$(bash ./.github/scripts/detect-model.sh)

          # Parse and output results
          echo "model=$(echo "$RESULT" | jq -r '.model')" >> $GITHUB_OUTPUT
          echo "selection_method=$(echo "$RESULT" | jq -r '.selection_method')" >> $GITHUB_OUTPUT
          {
            echo "reasoning<<$DELIM"
            echo "$RESULT" | jq -r '.reasoning'
            echo "$DELIM"
          } >> $GITHUB_OUTPUT

          # Detect which trigger phrase was used
          if echo "$TRIGGER_BODY" | grep -qi "@opus"; then
            echo "trigger_phrase=@opus" >> $GITHUB_OUTPUT
          elif echo "$TRIGGER_BODY" | grep -qi "@sonnet"; then
            echo "trigger_phrase=@sonnet" >> $GITHUB_OUTPUT
          elif echo "$TRIGGER_BODY" | grep -qi "@haiku"; then
            echo "trigger_phrase=@haiku" >> $GITHUB_OUTPUT
          else
            echo "trigger_phrase=@claude" >> $GITHUB_OUTPUT
          fi

      - name: Install gh-models extension
        if: steps.detect_model.outputs.selection_method == 'default'
        run: gh extension install https://github.com/github/gh-models
        env:
          GH_TOKEN: ${{ github.token }}

      - name: AI model selection
        if: steps.detect_model.outputs.selection_method == 'default'
        id: ai_select
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create variables file for the prompt
          cat > /tmp/model-select-vars.json << 'VARSEOF'
          {
            "event": "${{ github.event_name }}",
            "trigger": "${{ steps.detect_model.outputs.trigger_phrase }}",
            "title": "${{ github.event.issue.title || github.event.pull_request.title || 'N/A' }}",
            "request": ${{ toJson(github.event.comment.body || github.event.issue.body || github.event.review.body || 'N/A') }},
            "labels": "${{ join(github.event.issue.labels.*.name, ', ') || 'none' }}"
          }
          VARSEOF

          # Run the model with the prompt file
          RESPONSE=$(gh models run .github/prompts/model-selector.prompt.yaml \
            --variables /tmp/model-select-vars.json 2>/dev/null || echo '{"model":"sonnet","reason":"AI inference failed"}')

          # Parse response
          MODEL=$(echo "$RESPONSE" | jq -r '.model // "sonnet"')
          REASON=$(echo "$RESPONSE" | jq -r '.reason // "AI selection"')

          # Validate model
          if [[ ! "$MODEL" =~ ^(haiku|sonnet|opus)$ ]]; then
            MODEL="sonnet"
            REASON="Invalid AI response, defaulting to sonnet"
          fi

          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT
          echo "success=true" >> $GITHUB_OUTPUT

      - name: Determine final model
        id: final_model
        run: |
          # Priority 1: Direct trigger (@opus, @sonnet, @haiku)
          if [ "${{ steps.detect_model.outputs.selection_method }}" = "direct_trigger" ]; then
            echo "model=${{ steps.detect_model.outputs.model }}" >> $GITHUB_OUTPUT
            echo "method=direct_trigger" >> $GITHUB_OUTPUT
            echo "reasoning=${{ steps.detect_model.outputs.reasoning }}" >> $GITHUB_OUTPUT
          # Priority 2: AI selection for plain @claude
          elif [ "${{ steps.ai_select.outputs.success }}" = "true" ]; then
            echo "model=${{ steps.ai_select.outputs.model }}" >> $GITHUB_OUTPUT
            echo "method=ai_inference (gpt-5-nano)" >> $GITHUB_OUTPUT
            echo "reasoning=${{ steps.ai_select.outputs.reason }}" >> $GITHUB_OUTPUT
          # Fallback: sonnet
          else
            echo "model=sonnet" >> $GITHUB_OUTPUT
            echo "method=fallback" >> $GITHUB_OUTPUT
            echo "reasoning=AI inference unavailable, defaulting to sonnet" >> $GITHUB_OUTPUT
          fi

      - name: Log model selection
        run: |
          echo "### Model Selection" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Model | \`${{ steps.final_model.outputs.model }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Method | ${{ steps.final_model.outputs.method }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Reasoning | ${{ steps.final_model.outputs.reasoning }} |" >> $GITHUB_STEP_SUMMARY

      - name: Post model selection comment
        if: steps.final_model.outputs.method == 'ai_inference (gpt-5-nano)'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MODEL: ${{ steps.final_model.outputs.model }}
          SELECTION_METHOD: ${{ steps.final_model.outputs.method }}
          REASONING: ${{ steps.final_model.outputs.reasoning }}
          EVENT_NAME: ${{ github.event_name }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          # Determine target number (issue or PR)
          if [ -n "$PR_NUMBER" ]; then
            TARGET_NUMBER="$PR_NUMBER"
          elif [ -n "$ISSUE_NUMBER" ]; then
            TARGET_NUMBER="$ISSUE_NUMBER"
          else
            echo "No issue or PR number found, skipping comment"
            exit 0
          fi

          # Create comment body
          COMMENT_BODY=$(cat <<EOF
          ðŸ¤– **Model Selection** (AI-powered)

          | Field | Value |
          |-------|-------|
          | Model | \`$MODEL\` |
          | Method | $SELECTION_METHOD |
          | Reasoning | $REASONING |
          EOF
          )

          # Post comment
          gh issue comment "$TARGET_NUMBER" --body "$COMMENT_BODY"
          echo "Posted model selection comment to #$TARGET_NUMBER"

      - name: Collect workflow telemetry
        uses: catchpoint/workflow-telemetry-action@v2
        with:
          metric_frequency: 5
          proc_trace_sys_enable: true
          proc_trace_chart_show: true

      # Backend Dependencies Setup
      - name: Setup Backend
        uses: ./.github/actions/setup-backend
        with:
          install-golangci-lint: 'true'

      - name: Setup TailwindCSS
        uses: ./.github/actions/setup-tailwind

      - name: Setup Frontend
        uses: ./.github/actions/setup-frontend

      - name: Install E2E dependencies
        run: cd e2e && pnpm install --frozen-lockfile

      - name: Install Playwright browsers
        run: cd e2e && pnpm exec playwright install chromium

      - name: Generate CSS
        run: make css

      - name: Setup Database
        uses: ./.github/actions/setup-database
        with:
          db-name: iota_sdk_claude

      - name: Create artifacts directory
        run: mkdir -p .ci-artifacts/screenshots

      - name: Build MCP config
        id: mcp_config
        env:
          BLOOM_TOKEN: ${{ secrets.BLOOM_MCP_TOKEN }}
        run: |
          # Read base config and add bloom with token
          MCP_CONFIG=$(cat .github/claude/mcp-config.json | jq --arg token "$BLOOM_TOKEN" '.mcpServers.bloom = {"type":"http","url":"https://api.bloom.pw/api/mcp","name":"bloom","headers":{"Authorization":"Bearer \($token)"}}')
          # Export as multi-line output
          echo "config<<EOF" >> $GITHUB_OUTPUT
          echo "$MCP_CONFIG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Start Server
        id: server
        uses: ./.github/actions/start-server
        with:
          port: '3200'
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: iota_sdk_claude
          PORT: 3200
          SESSION_DURATION: 720h
          DOMAIN: localhost:3200
          GO_APP_ENV: test
          LOG_LEVEL: info

      - name: Run Claude Code
        id: claude
        uses: anthropics/claude-code-action@v1.0.23
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: iota_sdk_claude
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/iota_sdk_claude
          PORT: 3200
          SESSION_DURATION: 720h
          DOMAIN: localhost:3200
          GO_APP_ENV: test
          LOG_LEVEL: info
          BASE_URL: http://localhost:3200
          CI: true
          OPENAI_KEY: ${{ secrets.OPENAI_API_KEY }}
          AICHAT_TEST_SERVER_URL: http://localhost:3200
          RAILWAY_API_TOKEN: ${{ secrets.RAILWAY_SERVICE_TOKEN }}
          USE_AGENT_SDK: 'true'
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.MCP_GITHUB_TOKEN }}
          settings: |
            {
              "env": {
                "CLAUDE_CODE_MAX_OUTPUT_TOKENS": 50000,
                "BASH_DEFAULT_TIMEOUT_MS": 120000,
                "CI": "true",
                "GO_APP_ENV": "test"
              },
              "permissions": {
                "deny": [
                  "Read(**/*.key)",
                  "Read(**/*.pem)",
                  "Read(**/credentials*)",
                  "Read(**/.env)",
                  "Read(**/.env.*)",
                  "Bash(sudo:*)",
                  "Bash(rm -rf /*)"
                ]
              }
            }
          # NOTE: --dangerously-skip-permissions is intentional for full CI automation.
          # The settings.deny rules above serve as documentation of dangerous operations
          # that Claude should avoid, but are not enforced restrictions.
          claude_args: "--dangerously-skip-permissions --model ${{ steps.final_model.outputs.model }} --mcp-config '${{ steps.mcp_config.outputs.config }}'"
          show_full_output: "true"
          track_progress: "true"
          trigger_phrase: "${{ steps.detect_model.outputs.trigger_phrase }}"
          assignee_trigger: "claude"
          additional_permissions: "actions: read"

      - name: Stop application server
        if: always()
        run: |
          if [ -f server.pid ]; then
            SERVER_PID=$(cat server.pid)
            echo "Stopping server process $SERVER_PID"
            kill $SERVER_PID 2>/dev/null || true
            sleep 2
            kill -9 $SERVER_PID 2>/dev/null || true
          fi

      - name: Upload server logs
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: server-logs
          path: server.log
          retention-days: 7

      - name: Get PR number
        id: get_pr
        if: always()
        run: |
          # For PR comments, get PR number from issue context
          if [ -n "${{ github.event.issue.pull_request }}" ]; then
            echo "number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.pull_request.number }}" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "number=" >> $GITHUB_OUTPUT
          fi

      - name: Upload Screenshots
        if: always()
        uses: ./.github/actions/upload-screenshots
        with:
          s3-prefix: claude
          r2-secret-access-key: ${{ secrets.R2_SECRET_ACCESS_KEY }}

      - name: Upload screenshots to PR description
        if: always() && steps.get_pr.outputs.number != ''
        run: |
          PR_NUMBER="${{ steps.get_pr.outputs.number }}"
          SCREENSHOTS_DIR=".ci-artifacts/screenshots"

          if [ ! -d "$SCREENSHOTS_DIR" ] || [ -z "$(ls -A "$SCREENSHOTS_DIR" 2>/dev/null)" ]; then
            echo "No screenshots found, skipping PR update"
            exit 0
          fi

          CURRENT_BODY=$(gh pr view "$PR_NUMBER" --json body --jq '.body' 2>/dev/null || echo "")
          ARTIFACT_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          SCREENSHOTS_SECTION=$(printf '\n## Screenshots\n\nScreenshots are available as artifacts in the workflow run:\n[View Screenshots Artifact](%s)\n' "$ARTIFACT_URL")

          if [ -n "$CURRENT_BODY" ] && echo "$CURRENT_BODY" | grep -q "## Screenshots"; then
            echo "Screenshots section already exists, skipping update"
            exit 0
          fi

          NEW_BODY="${CURRENT_BODY}${SCREENSHOTS_SECTION}"
          TEMP_BODY=$(mktemp)
          echo "$NEW_BODY" > "$TEMP_BODY"
          gh pr edit "$PR_NUMBER" --body-file "$TEMP_BODY"
          rm -f "$TEMP_BODY"
          echo "Updated PR #$PR_NUMBER with screenshots section"
        env:
          GH_TOKEN: ${{ github.token }}
