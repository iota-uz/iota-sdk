name: Test, lint & build

on:
  - push

jobs:
  lint-and-format:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    timeout-minutes: 15
    name: Code Quality & Formatting

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: useblacksmith/setup-go@v6
        with:
          go-version: "1.23.2"

      - name: Install golangci-lint
        run: |
          curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v2.1.6
          golangci-lint version

      - name: Install templ
        run: |
          go install github.com/a-h/templ/cmd/templ@v0.3.857
          templ --help

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.19.0

      - name: Install JS dependencies (Tailwind v4)
        run: pnpm install --frozen-lockfile

      - name: Install pg_formatter for SQL formatting
        run: |
          sudo apt-get update
          sudo apt-get install -y pgformatter

      - name: Install just
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
          just --version

      - name: Download Go dependencies
        run: go mod download

      - name: Test generated files are up to date
        run: |
          just generate
          git diff --exit-code

      - name: Check translation files
        run: just check tr

      - name: Enforce applet SDK dependency policy
        run: just applet deps-check

      - name: Check templ files formatting
        run: |
          templ fmt .
          if [ -n "$(git diff --name-only)" ]; then
            echo "Error: Some templ files are not properly formatted"
            git diff
            exit 1
          fi
          echo "All templ files are properly formatted"

      - name: Check Go files formatting
        run: |
          go fmt ./...
          if [ -n "$(git diff --name-only)" ]; then
            echo "Error: Some Go files are not properly formatted"
            git diff
            exit 1
          fi
          echo "All Go files are properly formatted"

      - name: Check SQL files formatting
        run: |
          mkdir -p /tmp/formatted
          find modules -name "*.sql" -type f | while read -r sqlfile; do
            pg_format "$sqlfile" > "/tmp/formatted/$(basename "$sqlfile")"
            if ! diff -q "$sqlfile" "/tmp/formatted/$(basename "$sqlfile")" > /dev/null; then
              echo "Error: $sqlfile is not properly formatted"
              diff "$sqlfile" "/tmp/formatted/$(basename "$sqlfile")"
              exit 1
            fi
          done
          echo "All SQL files are properly formatted"

      - name: Run go vet
        run: go vet -tags dev ./...

      - name: Run BiChat smoke evals
        run: just eval

      - name: Check applet RPC contracts
        run: just applet rpc-check bichat

      - name: Typecheck BiChat applet
        run: pnpm -C modules/bichat/presentation/web exec tsc --noEmit

      - name: Generate CSS files
        run: just css

      - name: Run golangci-lint (unused variables/functions)
        run: just check lint

  test-unit-integration:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    name: Unit & Integration Tests

    services:
      postgres:
        image: postgres:17
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: iota_erp
          POSTGRES_INITDB_ARGS: "-c max_connections=1000 -c shared_buffers=2GB \
                                 -c effective_cache_size=6GB -c maintenance_work_mem=512MB \
                                 -c work_mem=32MB -c fsync=off -c synchronous_commit=off \
                                 -c full_page_writes=off -c wal_buffers=64MB \
                                 -c max_wal_size=4GB -c min_wal_size=1GB \
                                 -c checkpoint_completion_target=0.9 -c wal_compression=on \
                                 -c random_page_cost=1.0 -c seq_page_cost=1.0 \
                                 -c cpu_tuple_cost=0.01 -c cpu_index_tuple_cost=0.001 \
                                 -c cpu_operator_cost=0.0005 -c log_min_duration_statement=0 \
                                 -c log_statement=none -c log_checkpoints=off \
                                 -c log_connections=off -c log_disconnections=off \
                                 -c autovacuum=off -c track_activities=off \
                                 -c track_counts=off -c jit=off -c huge_pages=try \
                                 -c temp_buffers=128MB -c max_prepared_transactions=0 \
                                 -c bgwriter_delay=10000ms -c bgwriter_lru_maxpages=0 \
                                 -c effective_io_concurrency=200 -c maintenance_io_concurrency=200 \
                                 -c max_parallel_workers_per_gather=4 -c max_parallel_workers=8 \
                                 -c max_parallel_maintenance_workers=4 -c default_statistics_target=10 \
                                 -c enable_partitionwise_join=on -c enable_partitionwise_aggregate=on"
        options: >-
          --tmpfs /var/lib/postgresql/data:rw,size=6g,noatime
          --health-cmd="pg_isready -U postgres -d iota_erp"
          --health-interval=5s --health-timeout=5s --health-retries=5
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --tmpfs /data:rw,size=6g

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: useblacksmith/setup-go@v6
        with:
          go-version: "1.23.2"

      - name: Install just
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
          just --version

      - name: Install tools
        run: |
          # Install templ (needed for CSS generation)
          go install github.com/a-h/templ/cmd/templ@v0.3.857

      - name: Download Go dependencies
        run: go mod download

      - name: Wait for PostgreSQL to be ready
        run: |
          until pg_isready -h localhost -p 5432 -U postgres -d iota_erp; do
            echo "Waiting for postgres..."
            sleep 1
          done

      - name: Test just recipes
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: iota_erp
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: |
          just db migrate up
          just db migrate up
          just db seed
          just db seed

      - name: Run tests with coverage
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: iota_erp
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: go test -tags dev -v ./... -coverprofile=coverage.out -covermode=atomic

      - name: Generate coverage report
        env:
          COVERAGE_THRESHOLD: 10
          COVERAGE_MAX_FILES_DISPLAY: 100
          COVERAGE_IGNORE_PATTERNS: "cmd/,*_templ.go,viewmodels/"
        run: node ./.github/scripts/coverage-report.cjs --file coverage.out --output github

      - name: Generate HTML coverage report
        run: go tool cover -html=coverage.out -o coverage.html

      - name: Upload coverage to artifacts
        uses: actions/upload-artifact@v4
        with:
          name: code-coverage
          path: |
            coverage.out
            coverage.html

      - name: Test database migrate down
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: iota_erp
          DB_USER: postgres
          DB_PASSWORD: postgres
        run: just db migrate down

  test-e2e:
    runs-on: blacksmith-8vcpu-ubuntu-2404
    name: E2E Tests

    services:
      postgres:
        image: postgres:17
        ports:
          - 5432:5432
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: iota_erp_e2e
          POSTGRES_INITDB_ARGS: "-c max_connections=1000 -c shared_buffers=2GB \
                                 -c effective_cache_size=6GB -c maintenance_work_mem=512MB \
                                 -c work_mem=32MB -c fsync=off -c synchronous_commit=off \
                                 -c full_page_writes=off -c wal_buffers=64MB \
                                 -c max_wal_size=4GB -c min_wal_size=1GB \
                                 -c checkpoint_completion_target=0.9 -c wal_compression=on \
                                 -c random_page_cost=1.0 -c seq_page_cost=1.0 \
                                 -c cpu_tuple_cost=0.01 -c cpu_index_tuple_cost=0.001 \
                                 -c cpu_operator_cost=0.0005 -c log_min_duration_statement=0 \
                                 -c log_statement=none -c log_checkpoints=off \
                                 -c log_connections=off -c log_disconnections=off \
                                 -c autovacuum=off -c track_activities=off \
                                 -c track_counts=off -c jit=off -c huge_pages=try \
                                 -c temp_buffers=128MB -c max_prepared_transactions=0 \
                                 -c bgwriter_delay=10000ms -c bgwriter_lru_maxpages=0 \
                                 -c effective_io_concurrency=200 -c maintenance_io_concurrency=200 \
                                 -c max_parallel_workers_per_gather=4 -c max_parallel_workers=8 \
                                 -c max_parallel_maintenance_workers=4 -c default_statistics_target=10 \
                                 -c enable_partitionwise_join=on -c enable_partitionwise_aggregate=on"
        options: >-
          --tmpfs /var/lib/postgresql/data:rw,size=6g,noatime
          --health-cmd="pg_isready -U postgres -d iota_erp_e2e"
          --health-interval=5s --health-timeout=5s --health-retries=5
      redis:
        image: redis:latest
        ports:
          - 6379:6379
        options: >-
          --tmpfs /data:rw,size=6g

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Go
        uses: useblacksmith/setup-go@v6
        with:
          go-version: "1.23.2"

      - name: Install just
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://just.systems/install.sh | bash -s -- --to /usr/local/bin
          just --version

      - name: Install tools
        run: |
          # Install templ (needed for CSS generation)
          go install github.com/a-h/templ/cmd/templ@v0.3.857

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10.19.0

      - name: Install JS dependencies (Tailwind v4)
        run: pnpm install --frozen-lockfile

      - name: Download Go dependencies
        run: go mod download

      - name: Generate CSS files
        run: just css

      - name: Setup E2E database
        run: |
          just e2e reset

      - name: Install PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 10.19.0

      - name: Install Node dependencies
        run: pnpm install
        working-directory: e2e

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium
        working-directory: e2e

      - name: Start Go Server
        env:
          SESSION_DURATION: 720h
          DOMAIN: localhost
          PORT: 3201
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: iota_erp_e2e
          DB_USER: postgres
          DB_PASSWORD: postgres
          SID_COOKIE_KEY: sid
          GO_APP_ENV: production
          ENABLE_TEST_ENDPOINTS: true
        run: |
          go run -tags dev cmd/server/main.go &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

          # Wait for server to be ready (timeout: 60 seconds)
          timeout 60 bash -c 'until curl -s http://localhost:3201 > /dev/null; do sleep 1; done'

      - name: Run Playwright Tests
        env:
          BASE_URL: http://localhost:3201
        run: npx playwright test
        working-directory: e2e

      - name: Stop Go Server
        if: always()
        run: kill ${{ env.SERVER_PID }} || true

      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 30

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: e2e/test-results/
          retention-days: 30
