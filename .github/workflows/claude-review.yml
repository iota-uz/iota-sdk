name: Claude Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]

jobs:
  review:
    if: |
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       github.event.comment.user.type != 'Bot' &&
       contains(github.event.comment.body, '@review')) ||
      (github.event_name == 'pull_request_review_comment' &&
       github.event.comment.user.type != 'Bot' &&
       contains(github.event.comment.body, '@review')) ||
      (github.event_name == 'pull_request_review' &&
       github.event.review.user.type != 'Bot' &&
       contains(github.event.review.body, '@review'))
    uses: ./.github/workflows/_claude-reusable.yml
    with:
      model: opus
      prompt_file: .github/claude/prompts/review.md
      setup_level: full
      trigger_phrase: "@review"
      skip_permissions: true
      tools: "Read,Grep,Glob,Bash,Edit,Write,Task,TodoWrite,AskUserQuestion,WebFetch,WebSearch,Skill,BashOutput,KillShell"
      settings: |
        {
          "permissions": {
            "allow": [],
            "deny": [
              "Read(**/*.key)",
              "Read(**/*.pem)",
              "Read(**/credentials*)",
              "Read(**/.env)",
              "Read(**/.env.*)",
              "Bash(sudo:*)",
              "Bash(rm -rf /*)"
            ]
          }
        }
    secrets: inherit
